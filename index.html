<script>
  const materias = {
    "CBC": [
      { name: "QuÃ­mica" },
      { name: "Int. Con. Sociedad y Estado" },
      { name: "Int. Pensamiento CientÃ­fico" },
      { name: "MatemÃ¡tica" },
      { name: "FÃ­sica e Int. BiofÃ­sica" },
      { name: "BiologÃ­a e Int. BiologÃ­a Celular" }
    ],
    "Ciclo BiomÃ©dico - Primer AÃ±o": [
      { name: "AnatomÃ­a", requires: ["QuÃ­mica", "Int. Con. Sociedad y Estado", "Int. Pensamiento CientÃ­fico", "MatemÃ¡tica", "FÃ­sica e Int. BiofÃ­sica", "BiologÃ­a e Int. BiologÃ­a Celular"] },
      { name: "HistologÃ­a - BiologÃ­a Celular - GenÃ©tica", requires: ["QuÃ­mica", "Int. Con. Sociedad y Estado", "Int. Pensamiento CientÃ­fico", "MatemÃ¡tica", "FÃ­sica e Int. BiofÃ­sica", "BiologÃ­a e Int. BiologÃ­a Celular"] },
      { name: "Salud Mental", requires: ["QuÃ­mica", "Int. Con. Sociedad y Estado", "Int. Pensamiento CientÃ­fico", "MatemÃ¡tica", "FÃ­sica e Int. BiofÃ­sica", "BiologÃ­a e Int. BiologÃ­a Celular"] },
      { name: "BioÃ©tica I", requires: ["QuÃ­mica", "Int. Con. Sociedad y Estado", "Int. Pensamiento CientÃ­fico", "MatemÃ¡tica", "FÃ­sica e Int. BiofÃ­sica", "BiologÃ­a e Int. BiologÃ­a Celular"] },
      { name: "Medicina Familiar", requires: ["QuÃ­mica", "Int. Con. Sociedad y Estado", "Int. Pensamiento CientÃ­fico", "MatemÃ¡tica", "FÃ­sica e Int. BiofÃ­sica", "BiologÃ­a e Int. BiologÃ­a Celular"] }
    ],
    "Ciclo BiomÃ©dico - Segundo AÃ±o": [
      { name: "QuÃ­mica BiolÃ³gica", requires: ["AnatomÃ­a", "HistologÃ­a - BiologÃ­a Celular - GenÃ©tica"] },
      { name: "FisiologÃ­a y BiofÃ­sica", requires: ["AnatomÃ­a", "HistologÃ­a - BiologÃ­a Celular - GenÃ©tica"] }
    ],
    "Ciclo BiomÃ©dico - Tercer AÃ±o": [
      { name: "MicrobiologÃ­a y ParasitologÃ­a I", requires: ["FisiologÃ­a y BiofÃ­sica", "QuÃ­mica BiolÃ³gica"] },
      { name: "InmunologÃ­a Humana", requires: ["FisiologÃ­a y BiofÃ­sica", "QuÃ­mica BiolÃ³gica"] },
      { name: "MicrobiologÃ­a y ParasitologÃ­a II", requires: ["MicrobiologÃ­a y ParasitologÃ­a I"] },
      { name: "PatologÃ­a I", requires: ["FisiologÃ­a y BiofÃ­sica", "QuÃ­mica BiolÃ³gica"] },
      { name: "FarmacologÃ­a I", requires: ["FisiologÃ­a y BiofÃ­sica", "QuÃ­mica BiolÃ³gica"] }
    ],
    "Ciclo ClÃ­nico": [
      { name: "Medicina A (semiologÃ­a - fisiopatologÃ­a)", requires: ["MicrobiologÃ­a y ParasitologÃ­a II", "InmunologÃ­a Humana", "PatologÃ­a I", "FarmacologÃ­a I", "Salud Mental", "BioÃ©tica I"] },
      { name: "PatologÃ­a II", requires: ["PatologÃ­a I"] },
      { name: "Salud PÃºblica I", requires: ["MicrobiologÃ­a y ParasitologÃ­a I", "Medicina A (semiologÃ­a - fisiopatologÃ­a)"] },
      { name: "FarmacologÃ­a II", requires: ["FarmacologÃ­a I", "Salud PÃºblica I"] },
      { name: "Salud PÃºblica II", requires: ["Salud PÃºblica I"] },
      { name: "Medicina Legal - DeontologÃ­a MÃ©dica", requires: ["FarmacologÃ­a II"] },
      { name: "BioÃ©tica II", requires: ["BioÃ©tica I"] },
      { name: "ToxicologÃ­a", requires: ["Medicina A (semiologÃ­a - fisiopatologÃ­a)", "PatologÃ­a II"] }
    ],
    "ClÃ­nicas (Medicina Interna)": [
      { name: "Medicina B (Medicina Interna)", requires: ["Medicina A (semiologÃ­a - fisiopatologÃ­a)", "PatologÃ­a II"] },
      { name: "NutriciÃ³n" },
      { name: "DiagnÃ³stico por ImÃ¡genes" },
      { name: "DermatologÃ­a" },
      { name: "InfectologÃ­a" },
      { name: "NeumonologÃ­a" },
      { name: "NeurologÃ­a" },
      { name: "PsiquiatrÃ­a" }
    ],
    "QuirÃºrgicas": [
      { name: "PediatrÃ­a", requires: ["Medicina A (semiologÃ­a - fisiopatologÃ­a)", "PatologÃ­a II"] },
      { name: "Obstetricia" },
      { name: "GinecologÃ­a" },
      { name: "CirugÃ­a general" },
      { name: "UrologÃ­a" },
      { name: "Ortopedia - TraumatologÃ­a" },
      { name: "OftalmologÃ­a" },
      { name: "OtorrinolaringologÃ­a" },
      { name: "NeurocirugÃ­a" }
    ],
    "Ciclo Internado Anual Rotatorio": [
      { name: "ClÃ­nica MÃ©dica" },
      { name: "CirugÃ­a" },
      { name: "TocoginecologÃ­a" },
      { name: "PediatrÃ­a" },
      { name: "S. Mental" },
      { name: "APS" },
      { name: "MÃ³dulo EspecÃ­fico / Curso de Residencia" }
    ]
  };

  const storageKey = "malla_medicina_pastel";
  const modeKey = "modo_oscuro_medicina";
  let aprobadas = [];

  const params = new URLSearchParams(window.location.search);
  if (params.has("aprobadas")) {
    aprobadas = decodeURIComponent(params.get("aprobadas")).split(",");
  } else {
    aprobadas = JSON.parse(localStorage.getItem(storageKey)) || [];
  }

  function saveProgress() {
    localStorage.setItem(storageKey, JSON.stringify(aprobadas));
    const encoded = encodeURIComponent(aprobadas.join(","));
    const newUrl = `${window.location.pathname}?aprobadas=${encoded}`;
    history.replaceState(null, "", newUrl);
  }

  function isAprobada(name) {
    return aprobadas.includes(name);
  }

  function checkRequirements(requires) {
    if (!requires) return true;
    return requires.every(req => isAprobada(req));
  }

  function updateProgressBar() {
    const total = Object.values(materias).flat().length;
    const completed = aprobadas.length;
    const percentage = (completed / total) * 100;
    document.getElementById("progressBar").style.width = `${percentage}%`;

    if (!document.getElementById("progressText")) {
      const p = document.createElement("p");
      p.id = "progressText";
      p.style.margin = "0.5rem 0 0 1rem";
      p.style.fontWeight = "600";
      p.style.fontSize = "0.9rem";
      document.querySelector(".controls").prepend(p);
    }

    document.getElementById("progressText").textContent = `${completed} / ${total} materias aprobadas`;
  }

  function render() {
    const container = document.getElementById("malla");
    container.innerHTML = "";

    for (const ciclo in materias) {
      const col = document.createElement("div");
      col.className = "column";
      const h2 = document.createElement("h2");
      h2.textContent = ciclo;
      col.appendChild(h2);

      for (const mat of materias[ciclo]) {
        const div = document.createElement("div");
        div.className = "subject";
        div.textContent = mat.name;

        const approved = isAprobada(mat.name);
        const allowed = checkRequirements(mat.requires);

        if (approved) {
          div.classList.add("approved");
        } else if (!allowed) {
          div.classList.add("locked");
        }

        if (mat.requires) {
          div.setAttribute("data-tooltip", "ðŸ“Ž Requiere:\n" + mat.requires.join("\n"));
        }

        div.addEventListener("click", () => {
          if (div.classList.contains("locked")) return;

          if (approved) {
            aprobadas = aprobadas.filter(x => x !== mat.name);
          } else {
            aprobadas.push(mat.name);
          }
          saveProgress();
          render();
        });

        col.appendChild(div);
      }

      container.appendChild(col);
    }

    updateProgressBar();
  }

  function toggleMode() {
    document.body.classList.toggle("dark-mode");
    localStorage.setItem(modeKey, document.body.classList.contains("dark-mode"));
  }

  if (localStorage.getItem(modeKey) === "true") {
    document.body.classList.add("dark-mode");
  }

  render();
</script>
